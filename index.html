<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminarz SP57</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #2c3e50;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .add-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .add-button:hover {
            background-color: #2980b9;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
        }

        .calendar th.weekend {
            background-color: #34495e;
        }

        .calendar td {
            border: 1px solid #ddd;
            padding: 10px;
            height: 120px;
            vertical-align: top;
            position: relative;
        }

        .calendar td.weekend {
            background-color: #f8f9fa;
            color: #95a5a6;
        }

        .calendar td.empty {
            background-color: #f9f9f9;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-weight: bold;
            color: #555;
        }

        .weekend .day-number {
            color: #95a5a6;
        }

        .event {
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .absence {
            background-color: #e74c3c;
            color: white;
        }

        .trip {
            background-color: #9b59b6;
            color: white;
        }

        .holiday {
            background-color: #000000;
            color: white;
        }

        .custom {
            background-color: #ADD8E6;
            color: black;
        }

        .bookmark {
            background-color: #E8C547;
            color: black;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .time-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-range input {
            flex: 1;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .event-details {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .event-details p {
            margin-bottom: 8px;
        }

        .event-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .event-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .event-type {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .event-type.selected {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .menu {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #222;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .menu a {
            color: white;
            text-decoration: none;
            margin-bottom: 8px;
            font-family: Arial, sans-serif;
        }
        
        .menu a:hover {
            text-decoration: underline;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .news-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .news-item:last-child {
            border-bottom: none;
        }
        
        .news-time {
            color: #777;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .news-action {
            font-weight: bold;
            color: #2c3e50;
        }

        .class-selector-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .class-calendar-container {
            margin-top: 20px;
        }
        
        .info-box {
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<div class="menu">
    <a href="https://fillxd.github.io/sz57">Syst</a>
    <a href="https://fillxd.github.io/tm57">TM</a>
    <a href="https://fillxd.github.io/pl57">Plan</a>
    <a href="https://fillxd.github.io/na57">MG</a>
    <a href="https://fillxd.github.io/tk57">D5b</a>
    <a href="https://fillxd.github.io/kl57">T5b</a>
    <a href="https://docs.google.com/spreadsheets/d/18OV9Sar_ENFseGPn8wppwrIeJXm6j4dsa890OTg6Ioo/edit?gid=1302175797#gid=1302175797">ARK</a>
</div>

    <div class="container">
        <header>
            <h1>Terminarz Szkolny</h1>
            <div class="month-selector">
                <label for="month-select">Miesiąc:</label>
                <select id="month-select">
                    <option value="2025-09">Wrzesień 2025</option>
                    <option value="2025-10">Październik 2025</option>
                    <option value="2025-11">Listopad 2025</option>
                    <option value="2025-12">Grudzień 2025</option>
                    <option value="2026-01">Styczeń 2026</option>
                    <option value="2026-02">Luty 2026</option>
                    <option value="2026-03">Marzec 2026</option>
                    <option value="2026-04">Kwiecień 2026</option>
                    <option value="2026-05">Maj 2026</option>
                    <option value="2026-06">Czerwiec 2026</option>
                </select>
            </div>
            <button class="add-button" id="add-event-btn">DODAJ</button>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="calendar">Terminarz</button>
            <button class="tab" data-tab="news">Aktualności</button>
            <button class="tab" data-tab="class-calendar">Terminarz Klasowy</button>
        </div>

        <div class="tab-content active" id="calendar-tab">
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Poniedziałek</th>
                        <th>Wtorek</th>
                        <th>Środa</th>
                        <th>Czwartek</th>
                        <th>Piątek</th>
                        <th class="weekend">Sobota</th>
                        <th class="weekend">Niedziela</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                </tbody>
            </table>
        </div>

        <div class="tab-content" id="news-tab">
            <div id="news-container">
            </div>
        </div>

        <div class="tab-content" id="class-calendar-tab">
            <div class="class-selector-container">
                <label for="class-select">Wybierz klasę:</label>
                <select id="class-select">
                    <option value="">-- Wybierz klasę --</option>
                    <option value="1a">1a</option>
                    <option value="1b">1b</option>
                    <option value="1m">1m</option>
					<option value="2a">2a</option>
                    <option value="2b">2b</option>
                    <option value="2c">2c</option>
					<option value="3a">3a</option>
                    <option value="3b">3b</option>
                    <option value="3c">3c</option>
					<option value="4a">4a</option>
                    <option value="4b">4b</option>
                    <option value="4c">4c</option>
					<option value="5a">5a</option>
                    <option value="5b">5b</option>
                    <option value="5c">5c</option>
					<option value="6a">6a</option>
                    <option value="6b">6b</option>
                    <option value="6m">6m</option>
					<option value="7a">7a</option>
                    <option value="7b">7b</option>
                    <option value="7m">7m</option>
					<option value="8a">8a</option>
                    <option value="8b">8b</option>
                    <option value="8m">8m</option>
                </select>
            </div>
            <div id="class-calendar-container" class="class-calendar-container">
                <p>Wybierz klasę, aby zobaczyć nieobecności jej nauczycieli.</p>
            </div>
        </div>
    </div>

    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Dodaj wydarzenie</h2>
                <button class="close-button" id="close-modal">&times;</button>
            </div>
            <div id="modal-body">
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCzyqI6k2xHGM9mecAyGNJfAq7XjTKWqHs",
            authDomain: "na57-a08ec.firebaseapp.com",
            databaseURL: "https://na57-a08ec-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "na57-a08ec",
            storageBucket: "na57-a08ec.firebasestorage.app",
            messagingSenderId: "730540135505",
            appId: "1:730540135505:web:7a539a5eb3cb3d148d9470"
        };

        const classTeachersMap = {
            '1a': ["Weronika Rogalska", "Sylwia Kozakowska", "Katarzyna Sieczko", "Ignacy Włoszek", "Elżbieta Gawin", "Małgorzata Domagała", "Anna Grześkowiak", "Marlena Wyszyńska"],
            '1b': ["Katarzyna Buzdro", "Marlena Wyszyńska", "Antonnio Myszkowski", "Magdalena Joelesh", "Marcin Krupnicki", "Elżbieta Gawin", "Ignacy Włoszek"],
            '1m': ["Anna Brzeska", "Antonina Pawelczyk", "Hanna Brzeska", "Katarzyna Sieczko", "Elżbieta Gawin", "Ignacy Włoszek", "Marcin Krupnicki"],
            '2a': ["Martyna Kołodziejczyk", "Małgorzata Domagała", "Ignacy Włoszek", "Zofia Lisek", "Elżbieta Gawin"],
            '2b': ["Rozalia Lipska", "Kinga Młodzik", "Ignacy Włoszek", "Elżbieta Gawin", "Sylwia Cześniewicz", "Zofia Lisek"],
            '2c': ["Faustyna Dobrzek", "Zofia Lisek", "Ignacy Włoszek", "Michał Pietruszewski", "Natalia Raczyńska", "Elżbieta Gawin"],
            '3a': ["Alicja Rajewicz-Drzemała", "Marcin Krupnicki", "Katarzyna Sieczko", "Natalia Raczyńska", "Ignacy Włoszek", "Elżbieta Gawin"],
            '3b': ["Agnieszka Miłasz", "Natalia Raczyńska", "Katarzyna Sieczko", "Marcin Krupnicki", "Ignacy Włoszek", "Elżbieta Gawin"],
            '3c': ["Daria Musherina", "Marlena Wyszyńska", "Natalia Raczyńska", "Marcin Krupnicki", "Elżbieta Gawin", "Irynna Goshevniyk", "Ignacy Włoszek", "Celina Włodarczyk", "Anna Grześkowiak", "Urszula Złocińska"],
            '4a': ["Małgorzata Lesińska", "Grażyna Gruszka", "Karolina Dominiak", "Paweł Grzegorzewski", "Hanna Brzeska", "Marcin Krupnicki", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '4b': ["Małgorzata Lesińska", "Joanna Małek", "Marlena Wyszyńska", "Karolina Żukowska", "Hanna Brzeska", "Michał Pietruszewski", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '4c': ["Oliwia Żabkiewicz", "Renata Skleszewska", "Karolina Dominiak", "Karolina Żukowska", "Hanna Brzeska", "Kinga Młodzik", "Ewelina Śmigalska", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '5a': ["Oliwia Żabkiewicz", "Renata Skleszewska", "Karolina Dominiak", "Karolina Żukowska", "Hanna Brzeska", "Natalia Raczyńska", "Ewelina Śmigalska", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '5b': ["Oliwia Żabkiewicz", "Michał Tarczyn", "Zofia Lisek", "Karolina Żukowska", "Hanna Brzeska", "Michał Pietruszewski", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '5c': ["Małgorzata Lesińska", "Michał Tarczyn", "Zofia Lisek", "Paweł Grzegorzewski", "Hanna Brzeska", "Antonina Pawelczyk", "Natalia Raczyńska", "Bożena Szpilkiewicz", "Anna Burakowska", "Aleksandra Malczyk", "Mateusz Gig", "Karolina Dominiak", "Anna Grześkowiak", "Alicja Rajewicz-Drzemała", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '6a': ["Dorota Maszkiewska", "Grażyna Gruszka", "Katarzyna Sieczko", "Karolina Żukowska", "Hanna Brzeska", "Małgorzata Domagała", "Sylwia Cześniewicz", "Ewelina Śmigalska", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '6b': ["Dorota Maszkiewska", "Grażyna Gruszka", "Zofia Lisek", "Katarzyna Sieczko", "Karolina Żukowska", "Hanna Brzeska", "Sylwia Cześniewicz", "Ewelina Śmigalska", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '6m': ["Oliwia Żabkiewicz", "Renata Skleszewska", "Zofia Lisek", "Paweł Grzegorzewski", "Natalia Raczyńska", "Antonina Pawelczyk", "Hanna Brzeska", "Ewelina Śmigalska", "Mateusz Gig", "Barbara Trzaskowska", "Ludwik Parkowiak", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek"],
            '7a': ["Anna Burakowska", "Michał Tarczyn", "Celina Włodarczyk", "Paweł Grzegorzewski", "Hanna Brzeska", "Kinga Młodzik", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Marian Woźniak", "Mateusz Gig", "Barbara Trzaskowska", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek", "Antonnio Myszkowski", "Martyna Kołodziejczyk", "Magdalena Joelesh"],
            '7b': ["Dorota Maszkiewska", "Joanna Małek", "Celina Włodarczyk", "Karolina Żukowska", "Hanna Brzeska", "Kinga Młodzik", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Marian Woźniak", "Mateusz Gig", "Barbara Trzaskowska", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Magdalena Joelesh", "Antonnio Myszkowski", "Ignacy Włoszek", "Martyna Kołodziejczyk"],
            '7m': ["Dorota Maszkiewska", "Michał Tarczyn", "Katarzyna Sieczko", "Paweł Grzegorzewski", "Hanna Brzeska", "Bożena Szpilkiewicz", "Małgorzata Lesińska", "Alicja Rajewicz-Drzemała", "Anna Grześkowiak", "Marlena Wyszyńska", "Dariusz Drzemała", "Antonina Pawelczyk", "Małgorzata Domagała", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Antonnio Myszkowski", "Magdalena Joelesh", "Marian Woźniak", "Mateusz Gig", "Barbara Trzaskowska", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek", "Martyna Kołodziejczyk"],
            '8a': ["Anna Burakowska", "Joanna Małek", "Celina Włodarczyk", "Paweł Grzegorzewski", "Sylwia Cześniewicz", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Marian Woźniak", "Mateusz Gig", "Zuzanna Kośnicka", "Bożena Szpilkiewicz", "Alicja Rajewicz-Drzemała", "Anna Grześkowiak", "Marlena Wyszyńska", "Magdalena Joelesh", "Dariusz Drzemała", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek", "Ludwik Parkowiak", "Martyna Kołodziejczyk"],
            '8b': ["Elżbieta Gawin", "Joanna Małek", "Karolina Dominiak", "Paweł Grzegorzewski", "Sylwia Cześniewicz", "Magdalena Joelesh", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Marian Woźniak", "Mateusz Gig", "Dariusz Drzemała", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek", "Ludwik Parkowiak", "Martyna Kołodziejczyk"],
            '8m': ["Anna Burakowska", "Renata Skleszewska", "Celina Włodarczyk", "Paweł Grzegorzewski", "Antonina Pawelczyk", "Hanna Brzeska", "Małgorzata Domagała", "Ewelina Śmigalska", "Tadeusz Ostrowski", "Marian Woźniak", "Mateusz Gig", "Dariusz Drzemała", "Lena Skwierzyńska", "Elżbieta Gawin", "Zuzanna Świerczek", "Ignacy Włoszek", "Ludwik Parkowiak", "Martyna Kołodziejczyk"],
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let events = {};
        let news = [];
        let currentEditingEvent = null;
        let currentEditingDate = null;
        let currentEditingIndex = null;
        
        const monthSelect = document.getElementById('month-select');
        const calendarBody = document.getElementById('calendar-body');
        const addEventBtn = document.getElementById('add-event-btn');
        const eventModal = document.getElementById('event-modal');
        const closeModal = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const newsContainer = document.getElementById('news-container');
        const classSelect = document.getElementById('class-select');
        const classCalendarContainer = document.getElementById('class-calendar-container');
       
        function loadEvents() {
            return new Promise((resolve) => {
                database.ref('schoolCalendarEvents').on('value', (snapshot) => {
                    const data = snapshot.val();
                    events = data || {};
                    resolve(events);
                });
            });
        }
        
        function loadNews() {
            return new Promise((resolve) => {
                database.ref('schoolCalendarNews').on('value', (snapshot) => {
                    const data = snapshot.val();
                    news = data || [];
                    resolve(news);
                });
            });
        }

        function generateClassCalendar(className) {
            if (!classTeachersMap[className]) {
                classCalendarContainer.innerHTML = '<p>Brak danych dla wybranej klasy.</p>';
                return;
            }

            const classTeachers = classTeachersMap[className];
            const [year, month] = monthSelect.value.split('-').map(Number);
            
            let calendarHTML = '<div class="info-box">';
            calendarHTML += `<strong>ℹ️ Klasa ${className.toUpperCase()}</strong> - Nieobecności nauczycieli i dni wolne<br>`;
            calendarHTML += `<small>Nauczyciele: ${classTeachers.join(', ')}</small>`;
            calendarHTML += '</div>';
            
            calendarHTML += '<table class="calendar"><thead><tr>';
            calendarHTML += '<th>Poniedziałek</th><th>Wtorek</th><th>Środa</th><th>Czwartek</th><th>Piątek</th>';
            calendarHTML += '<th class="weekend">Sobota</th><th class="weekend">Niedziela</th>';
            calendarHTML += '</tr></thead><tbody>';
            
            const firstDay = new Date(year, month - 1, 1);
            const daysInMonth = new Date(year, month, 0).getDate();
            
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            let date = 1;
            
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<tr>';
                
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    if (week === 0 && dayOfWeek < firstDayOfWeek) {
                        calendarHTML += '<td class="empty"></td>';
                    } else if (date > daysInMonth) {
                        calendarHTML += '<td class="empty"></td>';
                    } else {
                        const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        const dayEvents = events[dateStr] || [];
                        
                        const filteredEvents = dayEvents.filter(event => {
                            if (event.type === 'holiday') {
                                return true;
                            }
                            if (event.type === 'absence' && classTeachers.includes(event.teacher)) {
                                return true;
                            }
                            if (event.type === 'trip' && event.className) {
                                return event.className.toLowerCase() === className.toLowerCase() || 
                                       event.className.toLowerCase().includes(className.toLowerCase());
                            }
                            return false;
                        });
                        
                        calendarHTML += `<td class="${isWeekend ? 'weekend' : ''}">`;
                        calendarHTML += `<div class="day-number">${date}</div>`;
                        
                        filteredEvents.forEach(event => {
                            let eventClass = '';
                            let eventText = '';
                            
                            if (event.type === 'absence') {
                                eventClass = 'absence';
                                eventText = `Nieobecność: ${event.teacher}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            } else if (event.type === 'holiday') {
                                eventClass = 'holiday';
                                eventText = `Dzień Wolny: ${event.title}`;
                            } else if (event.type === 'trip') {
                                eventClass = 'trip';
                                eventText = `Wycieczka klasy`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            }
                            
                            calendarHTML += `<div class="event ${eventClass}">${eventText}</div>`;
                        });
                        
                        calendarHTML += '</td>';
                        date++;
                    }
                }
                
                calendarHTML += '</tr>';
                
                if (date > daysInMonth) break;
            }
            
            calendarHTML += '</tbody></table>';
            
            classCalendarContainer.innerHTML = calendarHTML;
        }
        
        function saveEvents() {
            return database.ref('schoolCalendarEvents').set(events);
        }
        
        function saveNews() {
            return database.ref('schoolCalendarNews').set(news);
        }
        
        function addNewsItem(action, details) {
            const newsItem = {
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            news.unshift(newsItem);
            if (news.length > 100) {
                news = news.slice(0, 100);
            }
            
            return saveNews();
        }
        
        function updateCalendarFromSelector() {
            const [year, month] = monthSelect.value.split('-').map(Number);
            generateCalendar(year, month - 1);
            
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.getAttribute('data-tab') === 'class-calendar' && classSelect.value) {
                generateClassCalendar(classSelect.value);
            }
        }

        async function initCalendar() {
            await Promise.all([loadEvents(), loadNews()]);
            
            const now = new Date();
            const currentMonthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            monthSelect.value = currentMonthValue;
            
            updateCalendarFromSelector();
            displayNews();
        }
        
        function generateCalendar(year, month) {
            calendarBody.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            let date = 1;
            let calendarHTML = '';
            
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<tr>';
                
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    if (week === 0 && dayOfWeek < firstDayOfWeek) {
                        calendarHTML += '<td class="empty"></td>';
                    } else if (date > daysInMonth) {
                        calendarHTML += '<td class="empty"></td>';
                    } else {
                        const currentDate = new Date(year, month, date);
                        const dayOfMonth = currentDate.getDate();
                        const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                        
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                        const dayEvents = events[dateStr] || [];
                        
                        calendarHTML += `<td class="${isWeekend ? 'weekend' : ''}" data-date="${dateStr}">`;
                        calendarHTML += `<div class="day-number">${dayOfMonth}</div>`;
                        
                        dayEvents.forEach((event, index) => {
                            let eventClass = '';
                            let eventText = '';
                            
                            if (event.type === 'absence') {
                                eventClass = 'absence';
                                eventText = `Nieobecność: ${event.teacher}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            } else if (event.type === 'trip') {
                                eventClass = 'trip';
                                eventText = `Wycieczka: ${event.className}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            } else if (event.type === 'holiday') {
                                eventClass = 'holiday';
                                eventText = `Dzień Wolny: ${event.title}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            } else if (event.type === 'custom') {
                                eventClass = 'custom';
                                eventText = `${event.title}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            } else if (event.type === 'bookmark') {
                                eventClass = 'bookmark';
                                eventText = `${event.title}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                }
                            }
                            
                            calendarHTML += `<div class="event ${eventClass}" data-date="${dateStr}" data-index="${index}">${eventText}</div>`;
                        });
                        
                        calendarHTML += '</td>';
                        date++;
                    }
                }
                
                calendarHTML += '</tr>';
                
                if (date > daysInMonth) {
                    break;
                }
            }
            
            calendarBody.innerHTML = calendarHTML;
            
            document.querySelectorAll('.event').forEach(eventEl => {
                eventEl.addEventListener('click', function() {
                    const date = this.getAttribute('data-date');
                    const index = parseInt(this.getAttribute('data-index'));
                    showEventDetails(date, index);
                });
            });
        }
        
        function displayNews() {
            newsContainer.innerHTML = '';
            
            if (news.length === 0) {
                newsContainer.innerHTML = '<p>Brak aktualności.</p>';
                return;
            }
            
            news.forEach(item => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const timeAgo = getTimeAgo(item.timestamp);
                
                newsItem.innerHTML = `
                    <div class="news-action">${item.action}</div>
                    <div>${item.details}</div>
                    <div class="news-time">${timeAgo}</div>
                `;
                
                newsContainer.appendChild(newsItem);
            });
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Przed chwilą';
            } else if (diffMins < 60) {
                return `${diffMins} ${diffMins === 1 ? 'minutę' : diffMins < 5 ? 'minuty' : 'minut'} temu`;
            } else if (diffHours < 24) {
                return `${diffHours} ${diffHours === 1 ? 'godzinę' : diffHours < 5 ? 'godziny' : 'godzin'} temu`;
            } else if (diffDays < 7) {
                return `${diffDays} ${diffDays === 1 ? 'dzień' : 'dni'} temu`;
            } else {
                return past.toLocaleDateString('pl-PL');
            }
        }
        
        function showEventDetails(date, index) {
            const event = events[date][index];
            let detailsHTML = '';
            
            if (event.type === 'absence') {
                detailsHTML = `
                    <h3>Nieobecność</h3>
                    <div class="event-details">
                        <p><strong>Nauczyciel:</strong> ${event.teacher}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        ${event.reason ? `<p><strong>Powód:</strong> ${event.reason}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'trip') {
                detailsHTML = `
                    <h3>Wycieczka</h3>
                    <div class="event-details">
                        <p><strong>Klasa:</strong> ${event.className}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        ${event.description ? `<p><strong>Opis wycieczki:</strong> ${event.description}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'holiday') {
                detailsHTML = `
                    <h3>Dzień Wolny</h3>
                    <div class="event-details">
                        <p><strong>Tytuł:</strong> ${event.title}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'custom') {
                detailsHTML = `
                    <h3>Wydarzenie Niestandardowe</h3>
                    <div class="event-details">
                        <p><strong>Tytuł:</strong> ${event.title}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        ${event.description ? `<p><strong>Opis:</strong> ${event.description}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'bookmark') {
                detailsHTML = `
                    <h3>Zakładka</h3>
                    <div class="event-details">
                        <p><strong>Tytuł:</strong> ${event.title}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        ${event.description ? `<p><strong>Opis:</strong> ${event.description}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            }
            
            detailsHTML += `
                <div class="event-actions">
                    <button class="btn btn-primary" id="edit-event">Edytuj</button>
                    <button class="btn btn-danger" id="delete-event">Usuń</button>
                </div>
            `;
            
            modalTitle.textContent = 'Szczegóły wydarzenia';
            modalBody.innerHTML = detailsHTML;
            
            currentEditingEvent = event;
            currentEditingDate = date;
            currentEditingIndex = index;
            
            document.getElementById('edit-event').addEventListener('click', function() {
                showEventForm(event.type, true);
            });
            
            document.getElementById('delete-event').addEventListener('click', function() {
                if (confirm('Czy na pewno chcesz usunąć to wydarzenie?')) {
                    if (currentEditingEvent.type === 'absence' || currentEditingEvent.type === 'holiday' || currentEditingEvent.type === 'trip' || currentEditingEvent.type === 'custom' || currentEditingEvent.type === 'bookmark') {
                        const startDate = new Date(currentEditingEvent.startDate);
                        const endDate = new Date(currentEditingEvent.endDate || currentEditingEvent.startDate);
                        
                        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                            const dateKey = formatDateForStorage(d);
                            if (events[dateKey]) {
                                events[dateKey] = events[dateKey].filter(e => {
                                    if (e.type !== currentEditingEvent.type) return true;
                                    if (e.startDate !== currentEditingEvent.startDate) return true;
                                    
                                    if (e.type === 'absence') {
                                        return e.teacher !== currentEditingEvent.teacher || e.timeRange !== currentEditingEvent.timeRange;
                                    } else if (e.type === 'trip') {
                                        return e.className !== currentEditingEvent.className || e.timeRange !== currentEditingEvent.timeRange;
                                    } else {
                                        return e.title !== currentEditingEvent.title || e.timeRange !== currentEditingEvent.timeRange;
                                    }
                                });
                                if (events[dateKey].length === 0) {
                                    delete events[dateKey];
                                }
                            }
                        }
                    }
                    
                    if (currentEditingEvent.type !== 'bookmark') {
                        let newsAction = '';
                        let newsDetails = '';
                        
                        if (currentEditingEvent.type === 'absence') {
                            newsAction = 'Usunięto nieobecność nauczyciela';
                            const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                                ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                                : `w dniach ${formatDate(currentEditingEvent.startDate)}-${formatDate(currentEditingEvent.endDate)}`;
                            newsDetails = `${currentEditingEvent.teacher} ${dateRange}${currentEditingEvent.timeRange ? ` w godzinach ${currentEditingEvent.timeRange}` : ''}`;
                        } else if (currentEditingEvent.type === 'trip') {
                            newsAction = 'Usunięto wycieczkę';
                            const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                                ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                                : `w dniach ${formatDate(currentEditingEvent.startDate)}-${formatDate(currentEditingEvent.endDate)}`;
                            newsDetails = `dla klasy ${currentEditingEvent.className} ${dateRange}${currentEditingEvent.timeRange ? ` w godzinach ${currentEditingEvent.timeRange}` : ''}`;
                        } else if (currentEditingEvent.type === 'holiday') {
                            newsAction = 'Usunięto dzień wolny';
                            const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                                ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                                : `w dniach ${formatDate(currentEditingEvent.startDate)}-${formatDate(currentEditingEvent.endDate)}`;
                            newsDetails = `"${currentEditingEvent.title}" ${dateRange}${currentEditingEvent.timeRange ? ` w godzinach ${currentEditingEvent.timeRange}` : ''}`;
                        } else if (currentEditingEvent.type === 'custom') {
                            newsAction = 'Usunięto wydarzenie';
                            const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                                ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                                : `w dniach ${formatDate(currentEditingEvent.startDate)}-${formatDate(currentEditingEvent.endDate)}`;
                            newsDetails = `"${currentEditingEvent.title}" ${dateRange}${currentEditingEvent.timeRange ? ` w godzinach ${currentEditingEvent.timeRange}` : ''}`;
                        }
                        
                        addNewsItem(newsAction, newsDetails).then(() => {
                            saveEvents().then(() => {
                                initCalendar();
                                eventModal.style.display = 'none';
                                resetEditingContext();
                            });
                        });
                    } else {
                        saveEvents().then(() => {
                            initCalendar();
                            eventModal.style.display = 'none';
                            resetEditingContext();
                        });
                    }
                }
            });
            
            eventModal.style.display = 'flex';
        }
        
        function showEventForm(type = null, isEdit = false) {
            if (!type && !isEdit) {
                modalTitle.textContent = 'Dodaj wydarzenie';
                modalBody.innerHTML = `
                    <div class="event-type-selector">
                        <div class="event-type" data-type="absence">Nieobecność</div>
                        <div class="event-type" data-type="bulk-absence">Nieobecność Zbiorowa</div>
                        <div class="event-type" data-type="trip">Wycieczka</div>
                        <div class="event-type" data-type="holiday">Dzień Wolny</div>
                        <div class="event-type" data-type="custom">Wydarzenie Niestandardowe</div>
                        <div class="event-type" data-type="bookmark">Zakładka</div>
                    </div>
                `;
                
                document.querySelectorAll('.event-type').forEach(button => {
                    button.addEventListener('click', function() {
                        const selectedType = this.getAttribute('data-type');
                        showSpecificEventForm(selectedType, false);
                    });
                });
            } else {
                showSpecificEventForm(type, isEdit);
            }
            
            eventModal.style.display = 'flex';
        }
        
        function showSpecificEventForm(type, isEdit = false) {
            let formHTML = '';
            const eventData = isEdit ? currentEditingEvent : null;
            
            modalTitle.textContent = isEdit ? 'Edytuj wydarzenie' : 'Dodaj wydarzenie';
            
            if (type === 'bulk-absence') {
                formHTML = `
                    <div class="info-box">
                        <strong>ℹ️ Nieobecność Zbiorowa</strong><br>
                        <small>Wpisz nauczycieli po przecinku. Każda nieobecność zostanie zapisana osobno.</small>
                    </div>
                    <div class="form-group">
                        <label for="bulk-teachers">Nauczyciele (po przecinku):</label>
                        <textarea id="bulk-teachers" placeholder="Np. Jan Kowalski, Anna Nowak, Piotr Wiśniewski" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Data nieobecności:</label>
                        <div class="time-range">
                            <input type="date" id="bulk-absence-start-date" required>
                            <span>do</span>
                            <input type="date" id="bulk-absence-end-date">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bulk-absence-time">Godziny (np. 8:00-14:00):</label>
                        <input type="text" id="bulk-absence-time" placeholder="8:00-14:00">
                    </div>
                    <div class="form-group">
                        <label for="bulk-absence-reason">Powód nieobecności:</label>
                        <textarea id="bulk-absence-reason" placeholder="Np. wycieczka, szkolenie..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancel-form">Anuluj</button>
                        <button class="btn btn-primary" id="save-bulk-absence">Dodaj nieobecności</button>
                    </div>
                `;
                
                modalBody.innerHTML = formHTML;
                
                document.getElementById('cancel-form').addEventListener('click', function() {
                    eventModal.style.display = 'none';
                });
                
                document.getElementById('save-bulk-absence').addEventListener('click', function() {
                    saveBulkAbsence();
                });
                
                return;
            }
            
            if (type === 'absence') {
                formHTML = `
                    <div class="form-group">
                        <label for="absence-teacher">Nauczyciel:</label>
                        <input type="text" id="absence-teacher" value="${isEdit ? eventData.teacher : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data nieobecności:</label>
                        <div class="time-range">
                            <input type="date" id="absence-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <span>do</span>
                            <input type="date" id="absence-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="absence-time">Godziny (np. 8:00-14:00):</label>
                        <input type="text" id="absence-time" value="${isEdit ? eventData.timeRange || '' : ''}" placeholder="8:00-14:00">
                    </div>
                    <div class="form-group">
                        <label for="absence-reason">Powód nieobecności:</label>
                        <textarea id="absence-reason" placeholder="Np. choroba, szkolenie, urlop...">${isEdit ? eventData.reason || '' : ''}</textarea>
                    </div>
                `;
            } else if (type === 'trip') {
                formHTML = `
                    <div class="form-group">
                        <label for="trip-class">Klasa:</label>
                        <input type="text" id="trip-class" value="${isEdit ? eventData.className : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data wycieczki:</label>
                        <div class="time-range">
                            <input type="date" id="trip-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <span>do</span>
                            <input type="date" id="trip-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="trip-time">Godziny (np. 8:00-14:00):</label>
                        <input type="text" id="trip-time" value="${isEdit ? eventData.timeRange || '' : ''}" placeholder="8:00-14:00">
                    </div>
                    <div class="form-group">
                        <label for="trip-description">Opis wycieczki:</label>
                        <textarea id="trip-description">${isEdit ? eventData.description || '' : ''}</textarea>
                    </div>
                `;
            } else if (type === 'holiday') {
                formHTML = `
                    <div class="form-group">
                        <label for="holiday-title">Tytuł dnia wolnego:</label>
                        <input type="text" id="holiday-title" value="${isEdit ? eventData.title : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data dnia wolnego:</label>
                        <div class="time-range">
                            <input type="date" id="holiday-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <span>do</span>
                            <input type="date" id="holiday-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="holiday-time">Godziny (np. 8:00-14:00) - opcjonalnie:</label>
                        <input type="text" id="holiday-time" value="${isEdit ? eventData.timeRange || '' : ''}" placeholder="8:00-14:00">
                    </div>
                `;
            } else if (type === 'custom') {
                formHTML = `
                    <div class="form-group">
                        <label for="custom-title">Tytuł wydarzenia:</label>
                        <input type="text" id="custom-title" value="${isEdit ? eventData.title : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data wydarzenia:</label>
                        <div class="time-range">
                            <input type="date" id="custom-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <span>do</span>
                            <input type="date" id="custom-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="custom-time">Godziny (np. 8:00-14:00):</label>
                        <input type="text" id="custom-time" value="${isEdit ? eventData.timeRange || '' : ''}" placeholder="8:00-14:00">
                    </div>
                    <div class="form-group">
                        <label for="custom-description">Opis wydarzenia:</label>
                        <textarea id="custom-description">${isEdit ? eventData.description || '' : ''}</textarea>
                    </div>
                `;
            } else if (type === 'bookmark') {
                formHTML = `
                    <div class="form-group">
                        <label for="bookmark-title">Tytuł zakładki:</label>
                        <input type="text" id="bookmark-title" value="${isEdit ? eventData.title : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data zakładki:</label>
                        <div class="time-range">
                            <input type="date" id="bookmark-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <span>do</span>
                            <input type="date" id="bookmark-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bookmark-time">Godziny (np. 8:00-14:00):</label>
                        <input type="text" id="bookmark-time" value="${isEdit ? eventData.timeRange || '' : ''}" placeholder="8:00-14:00">
                    </div>
                    <div class="form-group">
                        <label for="bookmark-description">Opis zakładki:</label>
                        <textarea id="bookmark-description">${isEdit ? eventData.description || '' : ''}</textarea>
                    </div>
                `;
            }
            
            formHTML += `
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-form">Anuluj</button>
                    <button class="btn btn-primary" id="save-event">${isEdit ? 'Zapisz zmiany' : 'Dodaj'}</button>
                </div>
            `;
            
            modalBody.innerHTML = formHTML;
            
            document.getElementById('cancel-form').addEventListener('click', function() {
                eventModal.style.display = 'none';
                resetEditingContext();
            });
            
            document.getElementById('save-event').addEventListener('click', function() {
                saveEvent(type, isEdit);
            });
        }

        function saveBulkAbsence() {
            const teachersInput = document.getElementById('bulk-teachers').value.trim();
            const startDate = document.getElementById('bulk-absence-start-date').value;
            const endDate = document.getElementById('bulk-absence-end-date').value || startDate;
            const timeRange = document.getElementById('bulk-absence-time').value.trim();
            const reason = document.getElementById('bulk-absence-reason').value.trim();
            
            if (!teachersInput) {
                alert('Wpisz nauczycieli!');
                return;
            }
            
            if (!startDate) {
                alert('Podaj datę nieobecności!');
                return;
            }
            
            // Rozdziel nauczycieli po przecinku i usuń białe znaki
            const teachers = teachersInput.split(',').map(t => t.trim()).filter(t => t);
            
            if (teachers.length === 0) {
                alert('Wpisz przynajmniej jednego nauczyciela!');
                return;
            }
            
            // Dla każdego nauczyciela tworzymy osobną nieobecność
            teachers.forEach(teacher => {
                const eventData = {
                    type: 'absence',
                    teacher: teacher,
                    startDate: startDate,
                    endDate: endDate,
                    timeRange: timeRange,
                    reason: reason,
                    createdAt: new Date().toISOString()
                };
                
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateKey = formatDateForStorage(d);
                    
                    if (!events[dateKey]) {
                        events[dateKey] = [];
                    }
                    
                    const eventCopy = {...eventData};
                    eventCopy.date = dateKey;
                    events[dateKey].push(eventCopy);
                }
                
                // Dodaj osobną wiadomość do aktualności dla każdego nauczyciela
                const dateRange = startDate === endDate 
                    ? `w dniu ${formatDate(startDate)}`
                    : `w dniach ${formatDate(startDate)}-${formatDate(endDate)}`;
                
                const newsAction = 'Dodano nieobecność nauczyciela';
                const newsDetails = `${teacher} ${dateRange}${timeRange ? ` w godzinach ${timeRange}` : ''}`;
                
                addNewsItem(newsAction, newsDetails);
            });
            
            saveEvents().then(() => {
                initCalendar();
                eventModal.style.display = 'none';
            });
        }
        
        function saveEvent(type, isEdit = false) {
            const eventData = {
                type: type,
                createdAt: isEdit ? currentEditingEvent.createdAt : new Date().toISOString()
            };
            
            if (type === 'absence') {
                eventData.teacher = document.getElementById('absence-teacher').value;
                eventData.startDate = document.getElementById('absence-start-date').value;
                eventData.endDate = document.getElementById('absence-end-date').value || eventData.startDate;
                eventData.timeRange = document.getElementById('absence-time').value;
                eventData.reason = document.getElementById('absence-reason').value;
                
                if (!eventData.teacher || !eventData.startDate) {
                    alert('Proszę wypełnić wymagane pola');
                    return;
                }
            } else if (type === 'trip') {
                eventData.className = document.getElementById('trip-class').value;
                eventData.startDate = document.getElementById('trip-start-date').value;
                eventData.endDate = document.getElementById('trip-end-date').value || eventData.startDate;
                eventData.timeRange = document.getElementById('trip-time').value;
                eventData.description = document.getElementById('trip-description').value;
                
                if (!eventData.className || !eventData.startDate) {
                    alert('Proszę wypełnić wymagane pola');
                    return;
                }
            } else if (type === 'holiday') {
                eventData.title = document.getElementById('holiday-title').value;
                eventData.startDate = document.getElementById('holiday-start-date').value;
                eventData.endDate = document.getElementById('holiday-end-date').value || eventData.startDate;
                eventData.timeRange = document.getElementById('holiday-time').value;
                
                if (!eventData.title || !eventData.startDate) {
                    alert('Proszę wypełnić wymagane pola');
                    return;
                }
            } else if (type === 'custom') {
                eventData.title = document.getElementById('custom-title').value;
                eventData.startDate = document.getElementById('custom-start-date').value;
                eventData.endDate = document.getElementById('custom-end-date').value || eventData.startDate;
                eventData.timeRange = document.getElementById('custom-time').value;
                eventData.description = document.getElementById('custom-description').value;
                
                if (!eventData.title || !eventData.startDate) {
                    alert('Proszę wypełnić wymagane pola');
                    return;
                }
            } else if (type === 'bookmark') {
                eventData.title = document.getElementById('bookmark-title').value;
                eventData.startDate = document.getElementById('bookmark-start-date').value;
                eventData.endDate = document.getElementById('bookmark-end-date').value || eventData.startDate;
                eventData.timeRange = document.getElementById('bookmark-time').value;
                eventData.description = document.getElementById('bookmark-description').value;
                
                if (!eventData.title || !eventData.startDate) {
                    alert('Proszę wypełnić wymagane pola');
                    return;
                }
            }
            
            if (isEdit) {
                if (currentEditingEvent.type === 'absence' || currentEditingEvent.type === 'holiday' || currentEditingEvent.type === 'trip' || currentEditingEvent.type === 'custom' || currentEditingEvent.type === 'bookmark') {
                    const startDate = new Date(currentEditingEvent.startDate);
                    const endDate = new Date(currentEditingEvent.endDate || currentEditingEvent.startDate);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateForStorage(d);
                        if (events[dateKey]) {
                            events[dateKey] = events[dateKey].filter(e => {
                                if (e.type !== currentEditingEvent.type) return true;
                                if (e.startDate !== currentEditingEvent.startDate) return true;
                                
                                if (e.type === 'absence') {
                                    return e.teacher !== currentEditingEvent.teacher || e.timeRange !== currentEditingEvent.timeRange;
                                } else if (e.type === 'trip') {
                                    return e.className !== currentEditingEvent.className || e.timeRange !== currentEditingEvent.timeRange;
                                } else {
                                    return e.title !== currentEditingEvent.title || e.timeRange !== currentEditingEvent.timeRange;
                                }
                            });
                            if (events[dateKey].length === 0) {
                                delete events[dateKey];
                            }
                        }
                    }
                }
            }
            
            const startDate = new Date(eventData.startDate);
            const endDate = new Date(eventData.endDate);
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateKey = formatDateForStorage(d);
                
                if (!events[dateKey]) {
                    events[dateKey] = [];
                }
                
                const eventCopy = {...eventData};
                eventCopy.date = dateKey;
                events[dateKey].push(eventCopy);
            }
            
            if (type !== 'bookmark') {
                let newsAction = '';
                let newsDetails = '';

                if (type === 'absence') {
                    newsAction = isEdit ? 'Zmieniono nieobecność nauczyciela' : 'Dodano nieobecność nauczyciela';
                    const dateRange = eventData.startDate === eventData.endDate 
                        ? `w dniu ${formatDate(eventData.startDate)}`
                        : `w dniach ${formatDate(eventData.startDate)}-${formatDate(eventData.endDate)}`;
                    newsDetails = `${eventData.teacher} ${dateRange}${eventData.timeRange ? ` w godzinach ${eventData.timeRange}` : ''}`;
                } else if (type === 'trip') {
                    newsAction = isEdit ? 'Zmieniono wycieczkę' : 'Dodano wycieczkę';
                    const dateRange = eventData.startDate === eventData.endDate 
                        ? `w dniu ${formatDate(eventData.startDate)}`
                        : `w dniach ${formatDate(eventData.startDate)}-${formatDate(eventData.endDate)}`;
                    newsDetails = `dla klasy ${eventData.className} ${dateRange}${eventData.timeRange ? ` w godzinach ${eventData.timeRange}` : ''}`;
                } else if (type === 'holiday') {
                    newsAction = isEdit ? 'Zmieniono dzień wolny' : 'Dodano dzień wolny';
                    const dateRange = eventData.startDate === eventData.endDate 
                        ? `w dniu ${formatDate(eventData.startDate)}`
                        : `w dniach ${formatDate(eventData.startDate)}-${formatDate(eventData.endDate)}`;
                    newsDetails = `${dateRange}. ${eventData.title}${eventData.timeRange ? ` w godzinach ${eventData.timeRange}` : ''}`;
                } else if (type === 'custom') {
                    newsAction = isEdit ? 'Zmieniono wydarzenie' : 'Dodano wydarzenie';
                    const dateRange = eventData.startDate === eventData.endDate 
                        ? `w dniu ${formatDate(eventData.startDate)}`
                        : `w dniach ${formatDate(eventData.startDate)}-${formatDate(eventData.endDate)}`;
                    newsDetails = `"${eventData.title}" ${dateRange}${eventData.timeRange ? ` w godzinach ${eventData.timeRange}` : ''}`;
                }
                
                addNewsItem(newsAction, newsDetails).then(() => {
                    saveEvents().then(() => {
                        initCalendar();
                        eventModal.style.display = 'none';
                        resetEditingContext();
                    });
                });
            } else {
                saveEvents().then(() => {
                    initCalendar();
                    eventModal.style.display = 'none';
                    resetEditingContext();
                });
            }
        }
        
        function resetEditingContext() {
            currentEditingEvent = null;
            currentEditingDate = null;
            currentEditingIndex = null;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pl-PL');
        }
        
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('pl-PL');
        }
        
        function formatDateForStorage(date) {
            return date.toISOString().split('T')[0];
        }

        classSelect.addEventListener('change', function() {
            const selectedClass = this.value;
            
            if (!selectedClass) {
                classCalendarContainer.innerHTML = '<p>Wybierz klasę, aby zobaczyć nieobecności jej nauczycieli.</p>';
                return;
            }
            
            generateClassCalendar(selectedClass);
        });
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        monthSelect.addEventListener('change', updateCalendarFromSelector);
        addEventBtn.addEventListener('click', () => showEventForm());
        closeModal.addEventListener('click', () => {
            eventModal.style.display = 'none';
            resetEditingContext();
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === eventModal) {
                eventModal.style.display = 'none';
                resetEditingContext();
            }
        });
        
        initCalendar();
    </script>
</body>
</html>
